@using Academy.Application.Extensions
@using Academy.Domain.Enums.Ticket
@using Academy.Domain.ViewModels.TicketMessage.Admin
@model Academy.Domain.ViewModels.Ticket.Admin.AdminTicketViewModel
@{
    ViewData["Title"] = "جزئیات تیکت";
    var userId = User.GetUserId();
}

@section Breadcrumb
{
    <admin-breadcrumb page-title="@ViewData["Title"]">
        <admin-breadcrumb-item asp-area="Admin" asp-controller="Ticket" asp-action="List">لیست تیکت‌ها
        </admin-breadcrumb-item>
        <admin-breadcrumb-item last-active-item="true">@ViewData["Title"]</admin-breadcrumb-item>
    </admin-breadcrumb>
}

<div class="grid grid-cols-12 gap-x-6 gap-y-10">
    <div class="col-span-12">
        <div class="mt-3.5 flex flex-col gap-8">
        <div class="box box--stacked flex flex-col">
            <div class="flex flex-col gap-y-2 p-5 sm:flex-row sm:items-center">
                <h3 class="text-base font-bold opacity-95">@ViewData["Title"]<text class="font-normal"> : @Model.Title</text></h3>
                <div class="flex flex-col gap-x-3 gap-y-2 rtl:sm:mr-auto ltr:sm:ml-auto sm:flex-row">

                    <div data-tw-merge="" data-tw-placement="bottom-start" class="dropdown relative">
                        <a type="button" asp-area="Admin" asp-controller="Ticket" asp-action="List" data-tw-merge=""
                           data-tw-toggle="dropdown" aria-expanded="false"
                           class="transition duration-200 border shadow-sm inline-flex items-center justify-center py-2 px-3 rounded-md font-medium cursor-pointer focus:ring-4 focus:ring-primary focus:ring-opacity-20 focus-visible:outline-none dark:focus:ring-slate-700 dark:focus:ring-opacity-50 [&:hover:not(:disabled)]:bg-opacity-90 [&:hover:not(:disabled)]:border-opacity-90 [&:not(button)]:text-center disabled:opacity-70 disabled:cursor-not-allowed border-secondary text-slate-500 dark:border-darkmode-100/40 dark:text-slate-300 [&:hover:not(:disabled)]:bg-secondary/20 [&:hover:not(:disabled)]:dark:bg-darkmode-100/10 w-full sm:w-auto">
                            <i data-tw-merge="" data-lucide="corner-up-left"
                               class="rtl:ml-2 ltr:mr-2 h-4 w-4 stroke-[1.3]"></i>
                            بازگشت
                        </a>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="mt-3.5 flex flex-col gap-x-6 gap-y-10 lg:flex-row">
            <div class="flex w-full flex-col">
                <div class="box box--stacked flex flex-col p-5">
                    <div class="flex items-center gap-3.5 border-b border-primary pb-5">
                        <div>
                            <div
                                class="image-fit h-12 w-12 overflow-hidden rounded-full border-[3px] border-slate-200/70">
                                <a asp-area="Admin" asp-controller="User" asp-action="Details" asp-route-id="@Model.User.Id" target="_blank">
                                    <img
                                        src="@Model.User.AvatarImageName"
                                        alt="@Model.User.FullName">
                                </a>
                            </div>
                        </div>
                        <div>
                            <div class="max-w-[9rem] truncate font-medium md:max-w-none">
                                <a asp-area="Admin" asp-controller="User" asp-action="Details" asp-route-id="@Model.User.Id" target="_blank">
                                    @($"{Model.User.FirstName} {Model.User.LastName}")
                                </a>
                            </div>
                            <div class="mt-0.5 max-w-[9rem] truncate text-slate-500 md:max-w-none">
                                به: @Model.TicketSection.GetEnumName() - اولویت @Model.TicketPriority.GetEnumName()
                            </div>
                        </div>
                        <div class="rtl:mr-auto ltr:ml-auto flex gap-2">
                            @switch (Model.TicketStatus)
                            {
                                case TicketStatus.InProgress:
                                    <span class="flex items-center justify-center rounded-full text-yellow-700 bg-primary/5 border border-yellow-700 p-2 text-nowrap">در حال بررسی</span>
                                    break;
                                                
                                case TicketStatus.SupporterAnswered:
                                    <span class="flex items-center justify-center rounded-full text-green-700 bg-primary/5 border border-green-700 p-2 text-nowrap">پاسخ داده شده</span>
                                    break;     
                                                    
                                case TicketStatus.PendingForUserAnswer:
                                    <span class="flex items-center justify-center rounded-full text-blue-700 bg-primary/5 border border-blue-700 p-2 text-nowrap">در انتظار پاسخ کاربر</span>
                                    break;        
                                                    
                                case TicketStatus.Closed:
                                    <span class="flex items-center justify-center rounded-full text-red-700 bg-primary/5 border border-red-700 p-2 text-nowrap">بسته شده</span>
                                    break;
                            }
                        </div>
                    </div>


                    <div
                        class="scrollable-ref max-h-[46.6rem] -mx-3 overflow-y-auto [&:-webkit-scrollbar]:w-0 [&:-webkit-scrollbar]:bg-transparent [&_.simplebar-content]:p-0 [&_.simplebar-track.simplebar-vertical]:w-[10px] [&_.simplebar-track.simplebar-vertical]:mr-0.5 [&_.simplebar-track.simplebar-vertical_.simplebar-scrollbar]:before:bg-slate-400/20">
                        <div class="flex flex-col gap-3.5 px-3 py-5">
                            @foreach (var item in Model.Messages)
                            {
                                <div
                                    class="max-w-[85%] sm:max-w-none relative rtl:ml-auto ltr:mr-auto group rtl:[&.right]:ml-0 ltr:[&.right]:mr-0 rtl:[&.right]:mr-auto ltr:[&.right]:ml-auto flex items-end gap-3 [&.right]:flex-row-reverse @(item.SenderId == userId ? "" : "right")">
                                    <div class="hidden sm:block">
                                        <div
                                            class="image-fit h-12 w-12 overflow-hidden rounded-full border-[3px] border-slate-200/70">
                                            <img
                                                src="@item.Sender.AvatarImageName"
                                                alt="@item.Sender.FullName">
                                        </div>
                                    </div>
                                    <div
                                        class="rtl:rounded-l-xl ltr:rounded-r-xl rtl:rounded-tr-xl ltr:rounded-tl-xl border border-slate-200/80 bg-slate-50/80 px-4 pb-4 pt-3 rtl:group-[.right]:rounded-r-xl ltr:group-[.right]:rounded-l-xl rtl:group-[.right]:rounded-bl-none ltr:group-[.right]:rounded-br-none rtl:group-[.right]:text-left ltr:group-[.right]:text-right">
                                        <div>
                                            @Html.Raw(item.Message)
                                        </div>
                                        <div class="mt-4 flex items-center gap-10 group-[.right]:flex-row-reverse">
                                            <div
                                                class="rtl:ml-auto ltr:mr-auto flex items-center gap-2 rtl:group-[.right]:mr-auto ltr:group-[.right]:ml-auto rtl:group-[.right]:ml-0 ltr:group-[.right]:mr-0 group-[.right]:flex-row-reverse">
                                                <div class="text-xs text-slate-500/70">
                                                    @item.CreatedDate.ToHumanize()
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(item.AttachmentUrl))
                                    {
                                        <div data-tw-merge="" data-tw-placement=""
                                             class="absolute inset-y-0 rtl:left-0 ltr:right-0 my-auto rtl:-ml-8 ltr:-mr-8 h-5 w-5 rtl:group-[.right]:right-0 ltr:group-[.right]:left-0 rtl:group-[.right]:-mr-8 ltr:group-[.right]:-ml-8">
                                            <a href="@(item.AttachmentUrl)"
                                               download
                                               title="دانلود ضمیمه"
                                               data-tw-toggle=""
                                               aria-expanded="false"
                                               data-placement="top"
                                               class="tooltip cursor-pointer h-5 w-5 text-slate-500">
                                                <i data-tw-merge=""
                                                   data-lucide="download"
                                                   class="stroke-[1] w-5 h-5 fill-slate-400/70 stroke-slate-400/70"></i>
                                            </a>
                                        </div>
                                    }
                                </div>
                            }
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3.5 flex flex-col gap-x-6 gap-y-10 lg:flex-row">
            <div class="flex w-full flex-col">
                <div class="box box--stacked flex flex-col p-5">
                    <div class="relative">
                        <partial name="_CreateMessagePartial"
                                 model="new AdminCreateTicketMessageViewModel { TicketId = Model.Id, SenderId = userId, TicketStatus = Model.TicketStatus }"/>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>